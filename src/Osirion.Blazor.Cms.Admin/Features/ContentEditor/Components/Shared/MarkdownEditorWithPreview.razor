@namespace Osirion.Blazor.Cms.Admin.Features.ContentEditor.Components.Shared
@using Osirion.Blazor.Cms.Admin.Features.ContentEditor.Services
@using Osirion.Blazor.Cms.Admin.Shared.Components
@inherits BaseComponent
@inject IMarkdownEditorService MarkdownService

<div class="markdown-editor h-100 d-flex @(ShowPreview ? "editor-with-preview" : "editor-only")">
    <div class="editor-pane d-flex flex-column">
        @if (ShowToolbar)
        {
            <div class="editor-toolbar border-bottom px-2 py-1 sticky-top">
                <div class="btn-toolbar">
                    <div class="btn-group me-2">
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Bold"
                                @onclick="@(() => InsertMarkdown("**", "**", "bold text"))">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Italic"
                                @onclick="@(() => InsertMarkdown("*", "*", "italic text"))">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Heading"
                                @onclick="@(() => InsertMarkdown("## ", "", "Heading"))">
                            <i class="bi bi-type-h2"></i>
                        </button>
                    </div>
                    <div class="btn-group me-2">
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Link"
                                @onclick="@(() => InsertMarkdown("[", "](url)", "link text"))">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Image"
                                @onclick="@(() => InsertMarkdown("![", "](image-url)", "alt text"))">
                            <i class="bi bi-image"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Code"
                                @onclick="@(() => InsertMarkdown("```\n", "\n```", "code"))">
                            <i class="bi bi-code"></i>
                        </button>
                    </div>
                    <div class="btn-group">
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="List"
                                @onclick="@(() => InsertMarkdown("- ", "", "List item"))">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Task List"
                                @onclick="@(() => InsertMarkdown("- [ ] ", "", "Task item"))">
                            <i class="bi bi-check2-square"></i>
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-icon"
                                title="Quote"
                                @onclick="@(() => InsertMarkdown("> ", "", "Blockquote"))">
                            <i class="bi bi-blockquote-left"></i>
                        </button>
                    </div>
                </div>
            </div>
        }

        <div class="editor-container flex-grow-1">
            <textarea class="form-control h-100 border-0 editor-textarea font-monospace"
                      @bind="EditorContent"
                      @bind:event="oninput"
                      @onkeydown="HandleKeyDown"
                      @ref="TextAreaRef"
                      @onscroll="OnEditorScrolled"
                      placeholder="Write your markdown content here..."
                      @onfocus="OnEditorFocus"
                      @onblur="OnEditorBlur">
            </textarea>
        </div>
    </div>

    @if (ShowPreview)
    {
        <div class="preview-pane d-flex flex-column border-start">
            <div class="preview-header border-bottom px-3 py-2 sticky-top">
                <h6 class="mb-0 fw-medium">Preview</h6>
            </div>

            <div class="preview-container flex-grow-1 overflow-auto p-3" @ref="PreviewRef" @onscroll="OnPreviewScrolled">
                @if (!string.IsNullOrEmpty(Preview))
                {
                    <div class="markdown-preview">
                        @((MarkupString)Preview)
                    </div>
                }
                else
                {
                    <div class="text-muted fst-italic">
                        Preview will appear here as you type.
                    </div>
                }
            </div>
        </div>
    }
</div>