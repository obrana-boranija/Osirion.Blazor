@using Osirion.Blazor.Cms.Models
@inherits Osirion.Blazor.Components.OsirionComponentBase

<div class="@GetMetadataEditorClass()">
    <div class="osirion-admin-metadata-header">
        <h3 class="osirion-admin-metadata-title">Metadata</h3>
    </div>

    <div class="osirion-admin-metadata-content">
        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="title">Title</label>
            <input type="text"
                   class="osirion-admin-input"
                   id="title"
                   @bind="Metadata.Title"
                   placeholder="Enter title" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="description">Description</label>
            <textarea class="osirion-admin-textarea"
                      id="description"
                      @bind="Metadata.Description"
                      placeholder="Enter description"
                      rows="3"></textarea>
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="author">Author</label>
            <input type="text"
                   class="osirion-admin-input"
                   id="author"
                   @bind="Metadata.Author"
                   placeholder="Enter author" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="date">Date</label>
            <input type="date"
                   class="osirion-admin-input"
                   id="date"
                   @bind="PostDate" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="featuredImage">Featured Image URL</label>
            <input type="text"
                   class="osirion-admin-input"
                   id="featuredImage"
                   @bind="Metadata.FeaturedImage"
                   placeholder="Enter image URL" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="categories">Categories</label>
            <input type="text"
                   class="osirion-admin-input"
                   id="categories"
                   @bind="CategoriesInput"
                   placeholder="Enter categories (comma separated)" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-label" for="tags">Tags</label>
            <input type="text"
                   class="osirion-admin-input"
                   id="tags"
                   @bind="TagsInput"
                   placeholder="Enter tags (comma separated)" />
        </div>

        <div class="osirion-admin-form-group">
            <label class="osirion-admin-checkbox">
                <input type="checkbox" @bind="Metadata.IsFeatured" />
                <span>Featured Post</span>
            </label>
        </div>

        @if (ShowPreview)
        {
            <div class="osirion-admin-form-group">
                <label class="osirion-admin-label">Front Matter Preview</label>
                <pre class="osirion-admin-code-preview">@GetFormattedFrontMatter()</pre>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public FrontMatter Metadata { get; set; } = new();

    [Parameter]
    public EventCallback<FrontMatter> MetadataChanged { get; set; }

    [Parameter]
    public bool ShowPreview { get; set; } = true;

    private string CategoriesInput
    {
        get => string.Join(", ", Metadata.Categories);
        set
        {
            Metadata.Categories = ParseList(value);
            NotifyMetadataChanged();
        }
    }

    private string TagsInput
    {
        get => string.Join(", ", Metadata.Tags);
        set
        {
            Metadata.Tags = ParseList(value);
            NotifyMetadataChanged();
        }
    }

    private DateTime PostDate
    {
        get
        {
            if (DateTime.TryParse(Metadata.Date, out var date))
            {
                return date;
            }

            return DateTime.Now;
        }
        set
        {
            Metadata.Date = value.ToString("yyyy-MM-dd");
            NotifyMetadataChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        // Initialize with empty collections if null
        Metadata.Categories ??= new List<string>();
        Metadata.Tags ??= new List<string>();
    }

    private List<string> ParseList(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
        {
            return new List<string>();
        }

        return input
            .Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries)
            .Select(item => item.Trim())
            .Where(item => !string.IsNullOrWhiteSpace(item))
            .ToList();
    }

    private async Task NotifyMetadataChanged()
    {
        if (MetadataChanged.HasDelegate)
        {
            await MetadataChanged.InvokeAsync(Metadata);
        }
    }

    private string GetFormattedFrontMatter()
    {
        return Metadata.ToYaml();
    }

    private string GetMetadataEditorClass()
    {
        return $"osirion-admin-metadata-editor {CssClass}".Trim();
    }
}