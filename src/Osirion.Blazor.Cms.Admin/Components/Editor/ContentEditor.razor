@namespace Osirion.Blazor.Cms.Admin.Components.Editor
@inherits Osirion.Blazor.Cms.Admin.Common.Base.EditableComponentBase

<div class="@GetContentEditorClass()">
    @if (ViewModel.EditingPost == null)
    {
            <div class="osirion-admin-empty">
                <span>Select a file to edit or create a new file.</span>
            </div>
    }
    else
    {
            <div class="osirion-admin-editor-container">
                <div class="osirion-admin-editor-tabs">
                    <button type="button" 
                            class="osirion-admin-tab-button @(ActiveTab == "content" ? "active" : "")"
                            @onclick="@(() => SetActiveTab("content"))">
                        Content
                    </button>
                    <button type="button" 
                            class="osirion-admin-tab-button @(ActiveTab == "metadata" ? "active" : "")"
                        @onclick="@(() => SetActiveTab("metadata"))">
                        Metadata
                    </button>
                    <div class="osirion-admin-editor-actions">
                        <button type="button"
                                class="osirion-admin-button osirion-admin-button-icon"
                                title="Toggle Preview"
                                @onclick="TogglePreview">
                            <span class="osirion-admin-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>

                <div class="osirion-admin-editor-content">
                @if (ActiveTab == "content")
                {
                            <div class="osirion-admin-editor-main">
                                <MarkdownEditorPreview @ref="EditorPreviewRef"
                                                       Content="@ViewModel.EditingPost.Content"
                                                       ContentChanged="@((content) => UpdateContent(content))"
                                                       ShowToolbar="true"
                                                       EditorTitle="Markdown"
                                                       PreviewTitle="Preview"
                                                       AutoFocus="true"
                                                       SyncScroll="true"
                                                       ShowPreview="@IsPreviewVisible" />
                            </div>
                }
                else if (ActiveTab == "metadata")
                {
                            <MetadataEditor Metadata="@ViewModel.EditingPost.Metadata"
                                           MetadataChanged="@((metadata) => MarkAsDirty())"
                                           ShowPreview="true" />
                }
                </div>
            </div>

            <div class="osirion-admin-editor-footer">
                <div class="osirion-admin-editor-status">
                @if (IsDirty)
                {
                            <span class="osirion-admin-status-dirty">Changes not saved</span>
                }
                </div>

                <button type="button"
                        class="osirion-admin-button osirion-admin-button-secondary"
                        @onclick="DiscardChanges">
                    Discard Changes
                </button>

                <div class="osirion-admin-editor-main-actions">
                @if (ViewModel.IsCreatingNew)
                {
                            <div class="osirion-admin-form-group osirion-admin-form-group-inline">
                                <label class="osirion-admin-label" for="fileName">File Name:</label>
                                <input type="text"
                                       class="osirion-admin-input"
                                       id="fileName"
                                       @bind="ViewModel.FileName"
                                       placeholder="Enter file name" />
                                <span class="osirion-admin-input-suffix">.md</span>
                            </div>
                }

                @if (AskForCommitMessage)
                {
                            <CommitPanel CommitMessage="@ViewModel.CommitMessage"
                                        CommitMessageChanged="@((msg) => ViewModel.CommitMessage = msg)"
                                        OnCommitClicked="SaveChanges"
                                        OnCancelClicked="DiscardChanges"
                                        IsCommitting="@IsSaving" />
                }
                else
                {
                            <button type="button"
                                    class="osirion-admin-button osirion-admin-button-primary"
                                    @onclick="SaveChanges"
                                    disabled="@(IsSaving || (ViewModel.IsCreatingNew && string.IsNullOrWhiteSpace(ViewModel.FileName)))">
                        @if (IsSaving)
                        {
                                        <span class="osirion-admin-loading-spinner"></span>
                                        <span>Saving...</span>
                        }
                        else
                        {
                                        <span>Save Changes</span>
                        }
                            </button>
                }
                </div>
            </div>
    }
</div>