@using Osirion.Blazor.Theming.Services
@inherits OsirionComponentBase
@inject IOptions<ThemingOptions>? Options
@inject IThemeService ThemeService
@implements IDisposable

<link rel="stylesheet" href="_content/Osirion.Blazor/css/osirion.css" />
@if (!EffectiveOptions.UseDefaultStyles)
{
        <link rel="stylesheet" href="_content/Osirion.Blazor.Theming/css/osirion-theming.css" />
}
<link rel="stylesheet" href="_content/Osirion.Blazor.Navigation/css/osirion-navigation.css" />
<link rel="stylesheet" href="_content/Osirion.Blazor.Cms/css/osirion-content.css" />
<link rel="stylesheet" href="_content/Osirion.Blazor.Cms.Admin/css/osirion-admin.css" />

@if (!string.IsNullOrEmpty(CustomVariables))
{
        <style>
            :root {
        @((MarkupString)CustomVariables)
            }
        </style>
}

@if (!string.IsNullOrEmpty(GeneratedVariables))
{
        <style>
            :root {
        @((MarkupString)GeneratedVariables)
            }
        </style>
}

@if (EffectiveOptions.Framework != CssFramework.None)
{
        <style id="osirion-framework-style">
            html {
        @(GetFrameworkClassDeclaration())
            }
        </style>

    @* This script is essential for SSR pages that don't have ThemeProvider *@
        <script id="osirion-framework-script">
            (function() {
                function applyFrameworkIntegration() {
                    const htmlElement = document.documentElement || document.querySelector('html');
                    const frameworkClass = "@GetFrameworkClass()";

                    if (htmlElement && frameworkClass && !htmlElement.classList.contains(frameworkClass)) {
                        // Apply the correct framework class
                        htmlElement.classList.add(frameworkClass);
                    }
                }

                // Apply immediately
                applyFrameworkIntegration();

                // Apply on DOMContentLoaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', applyFrameworkIntegration);
                }
            })();
        </script>
}

@code {
    /// <summary>
    /// Gets or sets whether to use default styles
    /// </summary>
    [Parameter]
    public bool? UseStyles { get; set; }

    /// <summary>
    /// Gets or sets custom CSS variables
    /// </summary>
    [Parameter]
    public string? CustomVariables { get; set; }

    /// <summary>
    /// Gets or sets the CSS framework to integrate with
    /// </summary>
    [Parameter]
    public CssFramework? Framework { get; set; }

    /// <summary>
    /// Gets or sets the theme mode
    /// </summary>
    [Parameter]
    public ThemeMode? Mode { get; set; }

    /// <summary>
    /// Gets the effective options, merging parameters with configured options
    /// </summary>
    private ThemingOptions EffectiveOptions => new()
        {
            UseDefaultStyles = UseStyles ?? Options?.Value.UseDefaultStyles ?? true,
            CustomVariables = CustomVariables ?? Options?.Value.CustomVariables,
            Framework = Framework ?? Options?.Value.Framework ?? CssFramework.None,
            DefaultMode = Mode ?? Options?.Value.DefaultMode ?? ThemeMode.Light
        };

    /// <summary>
    /// Gets the generated CSS variables for the current theme
    /// </summary>
    private string GeneratedVariables => ThemeService.GenerateThemeVariables();

    /// <summary>
    /// Gets the framework class based on the selected framework
    /// </summary>
    private string GetFrameworkClass()
    {
        return EffectiveOptions.Framework switch
        {
            CssFramework.Bootstrap => "osirion-bootstrap-integration",
            CssFramework.FluentUI => "osirion-fluent-integration",
            CssFramework.MudBlazor => "osirion-mudblazor-integration",
            CssFramework.Radzen => "osirion-radzen-integration",
            _ => ""
        };
    }

    /// <summary>
    /// Gets the CSS declaration for the framework class
    /// </summary>
    private string GetFrameworkClassDeclaration()
    {
        var frameworkClass = GetFrameworkClass();
        return !string.IsNullOrEmpty(frameworkClass) ? $"class: \"{frameworkClass}\"" : "";
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}