@inject IContentProviderManager ContentProviderManager
@inherits OsirionComponentBase

<div class="@GetTagCloudClass()">
    @if (Title != null)
    {
        <h3 class="osirion-tag-cloud-title">@Title</h3>
    }

    @if (IsLoading)
    {
        <div class="osirion-loading">@LoadingText</div>
    }
    else if (Tags == null || !Tags.Any())
    {
        <div class="osirion-no-tags">@NoContentText</div>
    }
    else
    {
        <div class="osirion-tags-container">
            @foreach (var tag in Tags)
            {
                <a href="@GetTagUrl(tag)" class="osirion-tag-link" rel="nofollow">
                    @tag.Name
                    @if (ShowCount)
                    {
                        <span class="osirion-tag-count">@tag.Count</span>
                    }
                </a>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int? MaxTags { get; set; }

    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public string LoadingText { get; set; } = "Loading tags...";

    [Parameter]
    public string NoContentText { get; set; } = "No tags available.";

    [Parameter]
    public Func<ContentTag, string>? TagUrlFormatter { get; set; }

    [Parameter]
    public bool ShowCount { get; set; } = true;

    [Parameter]
    public bool SortByCount { get; set; } = true;

    private IReadOnlyList<ContentTag>? Tags { get; set; }
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadTagsAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadTagsAsync();
    }

    private async Task LoadTagsAsync()
    {
        IsLoading = true;
        try
        {
            var provider = ContentProviderManager.GetDefaultProvider();
            if (provider != null)
            {
                var allTags = await provider.GetTagsAsync();

                // Apply sorting
                if (SortByCount)
                {
                    allTags = allTags.OrderByDescending(t => t.Count).ToList();
                }
                else
                {
                    allTags = allTags.OrderBy(t => t.Name).ToList();
                }

                // Apply limit if specified
                Tags = MaxTags.HasValue
                    ? allTags.Take(MaxTags.Value).ToList()
                    : allTags;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error loading tags: {ex.Message}");
            Tags = Array.Empty<ContentTag>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetTagCloudClass()
    {
        return $"osirion-tag-cloud {CssClass}".Trim();
    }

    private string GetTagUrl(ContentTag tag)
    {
        return TagUrlFormatter?.Invoke(tag) ?? $"/tag/{tag.Slug}";
    }
}